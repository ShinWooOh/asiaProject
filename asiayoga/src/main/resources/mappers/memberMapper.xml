<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.company.asiayoga.mapper.memberMapper">
  
  	<sql id="commomPaging">
  		LIMIT #{totalRow} OFFSET #{paramPage}
  	</sql>
  
	<!-- 회원 목록  -->
	<select id="memberList" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper.memberList */
		SELECT 	@ROWNUM:=@ROWNUM+1 AS row_num,
				tempA.member_seq, 
				tempA.name, 
				tempA.my_membership, 
				tempA.sex, 
				tempA.phone, 
				tempA.email, 
				tempA.birth, 
				tempA.join_date, 
				tempA.memo, 
				tempA.store_seq,
				tempA.store_name,
				tempA.register_date, 
				tempA.adjournment_state 	
		FROM (
				SELECT	mbinfo.member_seq,
						mbinfo.name,
						mbinfo.my_membership,
			            mbinfo.sex,
			            mbinfo.phone,
			            mbinfo.email,
			            mbinfo.birth,
			            mbinfo.join_date,
			            mbinfo.memo,
			            mbinfo.store_seq,
			            ( SELECT store_name FROM storeinfo WHERE store_seq = mbinfo.store_seq) AS store_name,
			            mbinfo.register_date,
			            mbinfo.adjournment_state
				FROM memberinfo mbinfo 
				WHERE 1=1
				<choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND mbinfo.store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				</choose>
				AND mbinfo.del_yn = 'N'
				<if test="searchWord != null and searchWord != ''">
					AND 
					(		mbinfo.name LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.my_membership LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.birth LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.phone LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.email LIKE CONCAT('%',#{searchWord},'%')
					)
				</if>
			    ORDER BY mbinfo.join_date ASC
			    ) AS tempA, (SELECT @ROWNUM :=0) AS R
	    ORDER BY row_num DESC
	    <include refid="commomPaging"/>
	</select>
	
	<!-- 회원 목록 갯수  -->
	<select id="memberTotalCount" parameterType="memberVO" resultType="int">
  		/* memberMapper.memberTotalCount */
		SELECT count(*)
		FROM memberinfo mbinfo
		WHERE 1=1
		<choose>
			<when test="authority != 'ROLE_ADMIN'">
				AND mbinfo.store_seq = #{storeSeq}
			</when>
			<otherwise></otherwise>
		</choose>
		AND mbinfo.del_yn = 'N'
		<if test="searchWord != null and searchWord != ''">
			AND 
			(		mbinfo.name LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.my_membership LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.birth LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.phone LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.email LIKE CONCAT('%',#{searchWord},'%')
			)
		</if>
	</select>
	
	<!-- 회원 정보 상세  -->
	<select id="memberDetail" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper.memberDetail */
		SELECT	member_seq,
				name,
				my_membership,
	            sex,
	            phone,
	            email,
	            birth,
	            memo,
	            store_seq,
	            join_date,
	            register_date,
	            ( SELECt store_name FROM storeinfo WHERE store_seq = #{storeSeq} ) AS store_name
		FROM memberinfo
	    WHERE member_seq = #{memberSeq}
	    AND store_seq = #{storeSeq}
	</select>
	
	
	<!-- 회원 정보 등록  -->
	<insert id="memberInsert" parameterType="memberVO" useGeneratedKeys="true" keyProperty="memberSeq">
  		/* memberMapper.memberInsert */
		INSERT INTO memberinfo
				(	name,
					my_membership,
				 	sex,
					birth,
					phone,
					email,
					memo,
					store_seq,
					join_date,
					register_id,
					modify_id
				)
		VALUES
				(
					#{name},
					#{myMembership},
					#{sex},
					#{birth},
					#{phone},
					#{email},
					#{memo},
					#{storeSeq},
					#{joinDate},
					#{registerId},
					#{registerId}
				)
	</insert>
	
	<!-- 회원 정보 삭제  -->
	<update id="memberDel" parameterType="memberVO">
  		/* memberMapper.memberDel */
  		UPDATE memberinfo 
  		SET del_yn = 'Y',
  			modify_date = now(),
  			modify_id = #{modifyId}
  		WHERE member_seq = #{memberSeq}
  		AND store_seq = #{storeSeq} 
	</update>
	
	
	<!-- 회원 정보 업데이트  -->
	<update id="memberEdit" parameterType="memberVO">
  		/* memberMapper.memberEdit */
  		UPDATE memberinfo 
  		<set>
  			<if test="name != null and name != ''">name = #{name},</if>
  			<if test="myMembership != null and name != ''">my_membership = #{myMembership},</if>
  			<if test="sex != null and sex != ''">sex = #{sex},</if>
  			<if test="birth != null and birth != ''">birth = #{birth},</if>
  			<if test="phone != null and phone != ''">phone = #{phone},</if>
  			<if test="email != null and email != ''">email = #{email},</if>
  			<if test="memo != null and memo != ''">memo = #{memo},</if>
  			join_date = #{joinDate},
  			modify_date= now(),
  			modify_id = #{modifyId}
  		</set> 
  		WHERE member_seq = #{memberSeq}
  		AND store_seq = #{storeSeq}
  		AND del_yn ='N' 
	</update>
	
	
	<!--  회원 정보 검색(List 로 리턴, 상품과 함께 정보 제공)   -->
	<select id="memberSearchList" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper.memberSearchList */
		SELECT	@ROWNUM:=@ROWNUM+1 as row_num,
				mbinfo.member_seq,
				mbinfo.name,
				mbinfo.my_membership,
	            mbinfo.sex,
	            mbinfo.phone,
	            mbinfo.email,
	            mbinfo.birth,
	            mbinfo.join_date,
	            mbinfo.memo,
	            mbinfo.store_seq,
	            ( SELECT store_name FROM storeinfo WHERE store_seq= mbinfo.store_seq ) AS store_name,
	            mbinfo.register_date,
	            ordinfo.order_seq,
            	ordinfo.product_count,
                ordinfo.remaining_count,
                prdinfo.product_seq,
				prdinfo.product_name,
				( SELECT item_name FROM productitem WHERE item_seq = prdinfo.item_seq ) AS item_name
		FROM memberinfo mbinfo
        INNER JOIN orderinfo ordinfo
        ON mbinfo.member_seq = ordinfo.member_seq
        INNER JOIN productinfo prdinfo
    	ON ordinfo.product_seq = prdinfo.product_seq
		INNER JOIN (SELECT @ROWNUM :=0) AS R
		WHERE 1=1
		<choose>
			<when test="authority != 'ROLE_ADMIN'">
				AND mbinfo.store_seq = #{storeSeq}
			</when>
			<otherwise></otherwise>
		</choose>
		<if test="searchWord != null and searchWord != ''">
			AND 
			(		mbinfo.name LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.my_membership LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.phone LIKE CONCAT('%',#{searchWord},'%')
				OR 	mbinfo.email LIKE CONCAT('%',#{searchWord},'%')
			)
		</if>
		AND mbinfo.del_yn = 'N'
        AND ordinfo.expiration_yn = 'N'
        AND ordinfo.del_yn = 'N'
	    ORDER BY row_num DESC,mbinfo.join_date DESC
	</select>
	
	<!-- 검색 조건 팝업 창에서의 회원 목록  -->
	<select id="searchMemberList" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper.searchMemberList */
		SELECT	@ROWNUM:=@ROWNUM+1 as row_num,
				member_seq,
				name,
				my_membership,
	            sex,
	            phone,
	            email,
	            birth,
	            join_date,
	            memo,
	            store_seq,
	            register_date
		FROM memberinfo , (SELECT @ROWNUM :=0) AS R
		WHERE store_seq = #{storeSeq}
		<if test="searchWord != null and searchWord != ''">
			AND 
			(		name LIKE CONCAT('%',#{searchWord},'%')
				OR 	my_membership LIKE CONCAT('%',#{searchWord},'%')
				OR 	birth LIKE CONCAT('%',#{searchWord},'%')
				OR 	phone LIKE CONCAT('%',#{searchWord},'%')
				OR 	email LIKE CONCAT('%',#{searchWord},'%')
			)
		</if>
		AND del_yn = 'N'
	    ORDER BY join_date DESC, row_num DESC
	</select>
	
	<!-- 검색 조건 팝업 창에서의 상품목록  -->
	<select id="searchProductList" parameterType="productVO" resultType="productVO">
  		/* memberMapper.searchProductList */
		SELECT	@ROWNUM:=@ROWNUM+1 as row_num, 
				tempA.product_seq,
				tempA.store_seq,
				tempA.store_name,
				tempA.product_name,
				tempA.product_price,
				tempA.modify_date
		FROM (
				SELECT	prdinfo.product_seq,
						prdinfo.store_seq,
						(SELECT store_name FROM storeinfo WHERE store_seq = prdinfo.store_seq) AS store_name,
						prdinfo.product_name,
						prdinfo.product_price,
						prdinfo.modify_date
				FROM productinfo prdinfo
				WHERE del_yn = 'N'
				) AS tempA , (SELECT @ROWNUM :=0) AS R
		WHERE 1=1 
		<choose>
			<when test="authority != 'ROLE_ADMIN'">
				AND tempA.store_seq = #{storeSeq}
			</when>
			<otherwise></otherwise>
		</choose>
		<if test="searchWord != null and searchWord != ''">
			AND 
			(		tempA.product_name LIKE CONCAT('%',#{searchWord},'%')
				OR 	tempA.product_price LIKE CONCAT('%',#{searchWord},'%')
				OR 	tempA.store_name LIKE CONCAT('%',#{searchWord},'%')
			)
		</if>
	    ORDER BY tempA.modify_date DESC
	</select>
	
	<!-- 회원 목록 , 엑셀 다운로드 시 쓰인다.  -->
	<select id="memberExcelDown" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper.memberExcelDown */
		SELECT 	@ROWNUM:=@ROWNUM+1 AS row_num,
				tempA.member_seq, 
				tempA.name, 
				tempA.my_membership, 
				tempA.sex, 
				tempA.phone, 
				tempA.email, 
				tempA.birth, 
				tempA.join_date, 
				tempA.memo, 
				tempA.store_seq,
				tempA.store_name,
				tempA.register_date, 
				tempA.adjournment_state 	
		FROM (
				SELECT	mbinfo.member_seq,
						mbinfo.name,
						mbinfo.my_membership,
			            mbinfo.sex,
			            mbinfo.phone,
			            mbinfo.email,
			            mbinfo.birth,
			            mbinfo.join_date,
			            mbinfo.memo,
			            mbinfo.store_seq,
			            ( SELECT store_name FROM storeinfo WHERE store_seq = mbinfo.store_seq) AS store_name,
			            mbinfo.register_date,
			            mbinfo.adjournment_state
				FROM memberinfo mbinfo 
				WHERE 1=1
				<choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND mbinfo.store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				</choose>
				AND mbinfo.del_yn = 'N'
				<if test="searchWord != null and searchWord != ''">
					AND 
					(		mbinfo.name LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.my_membership LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.birth LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.phone LIKE CONCAT('%',#{searchWord},'%')
						OR 	mbinfo.email LIKE CONCAT('%',#{searchWord},'%')
					)
				</if>
			    ORDER BY mbinfo.join_date ASC
			    ) AS tempA  , (SELECT @ROWNUM :=0) AS R
	    ORDER BY row_num DESC
	</select>
	
	<!-- 회원 휴회 상태 변경  -->
	<update id="updateAdjournmentState" parameterType="memberVO">
  		/* memberMapper.updateAdjournmentState */
  		UPDATE memberinfo 
  		SET adjournment_state = #{adjournmentState},
  			modify_date = now(),
  			modify_id = #{modifyId}
  		WHERE member_seq = (SELECT member_seq FROM orderinfo WHERE order_seq =#{orderSeq} AND del_yn = 'N' LIMIT 1)
  		AND store_seq = (SELECT store_seq FROM orderinfo WHERE order_seq =#{orderSeq} AND del_yn = 'N' LIMIT 1) 
	</update>
	
	<!-- 회원 통계  -->
	<select id="memberStatistics" parameterType="memberVO" resultType="memberVO">
  		/* memberMapper."memberStatistics" */
		SELECT 
				( SELECT MONTH(CURDATE())
				) AS this_month,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose>
				  AND join_date BETWEEN CURDATE() and NOW()) AS new_day_member,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose>
				  AND join_date BETWEEN DATE_SUB(CURDATE(),INTERVAL(DAYOFWEEK(CURDATE())-1) DAY) AND DATE_ADD(CURDATE(),INTERVAL(7-DAYOFWEEK(CURDATE())) DAY)) AS new_week_member,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose> 
				  AND join_date BETWEEN DATE_SUB(CURDATE(),INTERVAL(DAYOFMONTH(CURDATE())-1) DAY) AND LAST_DAY(CURDATE())) AS new_month_member,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose> 
				  AND del_yn= 'N') AS total_member,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose> 
				  AND adjournment_state = 'Y' 
				  AND del_yn= 'N') AS adjournment_yes,
				( SELECT COUNT(1) 
				  FROM memberinfo 
				  WHERE 1=1
				  <choose>
					<when test="authority != 'ROLE_ADMIN'">
						AND store_seq = #{storeSeq}
					</when>
					<otherwise></otherwise>
				  </choose> 
				  AND adjournment_state = 'N' 
				  AND del_yn= 'N') AS adjournment_no
		FROM memberinfo
		GROUP by new_day_member,new_week_member,new_month_member,total_member,adjournment_yes,adjournment_no
	</select>
	
	<!-- 회원번호 중복 체크  -->
	<select id="myMembershipDupCheck" parameterType="memberVO" resultType="int">
  		/* memberMapper."myMembershipDupCheck" */
  		SELECT COUNT(1)
  		FROM memberinfo
  		WHERE del_yn= 'N'
  		AND my_membership = #{myMembership}
		AND store_seq = #{storeSeq}
	</select>
	
  </mapper>